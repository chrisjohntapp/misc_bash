#!/bin/bash

# Currently updates network config files and /etc/hosts, then restarts
# networking. If more changes are required (such as fstab, exports etc),
# additional function can easily be added base on what is already here.

# This script does not and should not change resolv.conf, as resolvers in both
# sites should be configured.

# TODO:
# Split found_old_prefixes test out into a function.
# Should require more than 1 failed ping to trigger actions.

primary_net='10.51.71'
primary_gateway='10.51.71.1'
dr_net='192.168.2'
dr_gateway='192.168.2.254'


#===============================================================================
# Setup Logging.
#===============================================================================

readonly script_name=$(basename "$0")
function log() {
    echo "$(date)" "$@"
    logger -s "$(date)" "$@" 2>> /var/log/dr.log
}
function err() {
    echo "$(date)" "$@" >&2
    logger -s "$(date)" "$@" 2>> /var/log/dr.log
}


#===============================================================================
# Check Location.
#===============================================================================

function ping_gateway() { # 1:gateway_ip
    log "Pinging gateway ${1}."
    quests continuously for 10 seconds. Typically 1 per second.
    ping -c10 -w1 "$1" > /dev/null
}


#===============================================================================
# Restart Networking.
#===============================================================================

function flush_interfaces() { # None

    # Remove all IP addresses from all network interfaces, except loopback.

    interfaces="$(basename -a /sys/class/net/*)"
    for i in ${interfaces}; do
        if [[ $i != 'lo' ]]; then
            log "Flushing config on $i."
            ip addr flush "$i"
        fi
    done
}

function restart_networking_centos() { # 1:os_version

    # Run scripts to restart networking, applying a new configuration.

    log "Restarting networking to apply the new configuration."
    case "$1" in
        6)
            service network restart
            ;;
        7)
            systemctl restart network.service
            ;;
        *) 
            log "CentOS version not supported."
            exit 1
            ;;
    esac
}

function restart_networking_ubuntu() { # 1:os_version

    # Run scripts to restart networking, applying a new configuration.

    log "Restaring networking to apply the new configuration."
    case "$1" in
        12.04)
            /etc/init.d/networking stop
            /etc/init.d/networking start
            ;;
        14.04)
            # See Ubuntu bug #1301015 for reasoning behind this.
            ifdown -a --exclude=lo
            ifup -a --exclude=lo
            ;;
        16.04)
            # Previous IPs are not removed by systemctl in 16.04.
            flush_interfaces
            systemctl restart networking.service
            ;;
        18.04)
            systemctl restart systemd-networkd.service
            ;;
        *    )
            log "Ubuntu version not recognised."
            exit 1
            ;;
    esac
}


#===============================================================================
# Update IP address(es).
#===============================================================================

function update_file() { # 1:file, 2:old_prefix, 3:new_prefix

    # Check for old_prefix in file, and if found change all examples for
    # new_prefix.

    if ! [[ $(cat "$1") =~ $2 ]]; then
        log "No IP address updates required."
        return
    else
        log "Changing network prefix from $2 to $3 on all IP addresses in $1."
        sed -i "s/$2/$3/g" "$1"
    fi
}

function update_ubuntu_12_14_16_interfaces() { # 1:old_prefix, 2:new_prefix

    # Check for old_prefix in network interface config files and if found
    # replace all examples with new_prefix.

    found_old_prefixes=$(find /etc/network/interfaces \
        /etc/network/interfaces.d -type f -exec grep "$1" {} \;)

    if [[ -z ${found_old_prefixes} ]]; then
        log "No IP address updates required."
        return 10
    else
        log "Changing network prefix from $1 to $2 on /etc/network/interfaces."
        sed -i "s/$1/$2/g" /etc/network/interfaces

        log "Collecting network config files."
        ifcfg_files=($(ls /etc/network/interfaces.d/*.cfg))

        for ((i=0; i<${#ifcfg_files[@]}; i++)); do
            log "Changing network from $1 to $2 on ${ifcfg_files[i]}."
            sed -i "s/$1/$2/g" "${ifcfg_files[i]}"
        done
    fi
}

function update_ubuntu_18_interfaces() { # 1:old_prefix, 2:new_prefix

    # Check for old_prefix in network interface config files and if found
    # replace all examples with new_prefix.

    found_old_prefixes=$(find /etc/netplan -type f -name '*.yaml' \
        -exec grep "$1" {} \;)

    if [[ -z ${found_old_prefixes} ]]; then
        log "No IP address updates required."
        return 10
    else
        log "Collecting network config files."
        ifcfg_files=($(ls /etc/netplan/*.yaml))

        for ((i=0; i<${#ifcfg_files[@]}; i++)); do
            log "Changing network prefix from $1 to $2 on ${ifcfg_files[i]}."
            sed -i "s/$1/$2/g" "${ifcfg_files[i]}"
        done
    fi
}

function update_centos_6_7_interfaces() { # 1:old_prefix, 2:new_prefix

    # Check for old_prefix in network interface config files and if found
    # replace all examples with new_prefix.

    found_old_prefixes=$(find /etc/sysconfig/network-scripts -type f \
        -name 'ifcfg-*' -exec grep "$1" {} \;)

    if [[ -z ${found_old_prefixes} ]]; then
        log "No IP address updates required."
        return 10
    else
        log "Collecting network config files."
        ifcfg_files=($(ls /etc/sysconfig/network-scripts/ifcfg-*))

        for ((i=0; i<${#ifcfg_files[@]}; i++)); do
            log "Changing network prefix from $1 to $2 on ${ifcfg_files[i]}."
            sed -i "s/$1/$2/g" "${ifcfg_files[i]}"
        done
    fi
}

function update_config() { # 1:os_vendor, 2:os_version, 3:old_prefix,
                           # 4:new_prefix}

    # Checks OS vendor and version and calls appropriate function to update
    # network config file(s). If changes are made by that function it then
    # calls a function to restart the host networking.
    # Then it calls functions to update any additional files which may contain
    # IP addresses (/etc/hosts for example).

    if [[ "$1" == "ubuntu" ]]; then
        case "$2" in
            1[246].04)
                update_ubuntu_12_14_16_interfaces "$3" "$4"
                [[ $? -ne 10 ]] && restart_networking_"$1" "$2"
                update_file /etc/hosts "$3" "$4"
                # update_file /etc/foobar "$3" "$4"
                ;;
            18.04    )
                update_ubuntu_18_interfaces "$3" "$4"
                [[ $? -ne 10 ]] && restart_networking_"$1" "$2"
                update_file /etc/hosts "$3" "$4"
                ;;
            *        )
                log "Ubuntu version not supported."
                exit 1
                ;;
        esac
    elif [[ "$1" == "centos" ]]; then
        case "$2" in
            [67])
                update_centos_6_7_interfaces "$3" "$4"
                [[ $? -ne 10 ]] && restart_networking_"$1" "$2"
                update_file /etc/hosts "$3" "$4"
                ;;
            *   )
                log "CentOS version not supported."
                exit 1
                ;;
        esac
    fi
}    


#===============================================================================
# Main.
#===============================================================================

# Gather info & validate.
os_vendor=$(grep -E "^ID=" /etc/os-release | cut -d"=" -f2 | sed 's/"//g') || \
    { log "Failed to identify OS vendor; exiting."; exit 1; }
os_version=$(grep -E "^VERSION_ID=" /etc/os-release | cut -d"=" -f2 | \
    sed 's/"//g') || { log "Failed to identify OS version; exiting."; exit 1; }

case "${os_vendor}" in
    ubuntu)
        if ! [[ "${os_version}" =~ 1[2468].04 ]]; then
            log "Ubuntu OS version not supported."
            exit 1
        fi
        ;;
    centos)
        if ! [[ "${os_version}" =~ [67] ]]; then
            log "CentOS version not supported."
            exit 1
        fi
        ;;
    *     )
        log "OS not supported."
        exit 1
        ;;
esac

# Try the primary gateway.
ping_gateway "${primary_gateway}"
if [ $? -eq 0 ]; then
    log "${primary_gateway} is reachable. This VM appears to be on primary \
network."
    exit 0
else
    log "${primary_gateway} is not reachable. Assuming we're on the DR site. \
Updating IP address(s) to DR site prefix, if required."
    update_config "${os_vendor}" "${os_version}" "${primary_net}" "${dr_net}"
fi

# Try the DR gateway.
ping_gateway "${dr_gateway}"
if [ $? -eq 0 ]; then
    log "${dr_gateway} is reachable. This VM appears to be on the DR network."
    exit 0
else
    log "${dr_gateway} is not reachable. Assuming we are on primary network. \
Updating IP address(es) to primary site prefix, if required."
    update_config "${os_vendor}" "${os_version}" "${dr_net}" "${primary_net}"
fi

